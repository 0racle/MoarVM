# Copyright (C) 2006-2012, The Perl Foundation.
# (Copy/paste/hack from NQP itself...)
# $Id$

PARROT_ARGS      =

# values from parrot_config
PARROT_BIN_DIR     = @bindir@
PARROT_LIB_SHARED  = @libparrot_shared@
PARROT_VERSION     = @versiondir@
PARROT_INCLUDE_DIR = @includedir@$(PARROT_VERSION)
PARROT_LIB_DIR     = @libdir@$(PARROT_VERSION)
PARROT_SRC_DIR     = @srcdir@$(PARROT_VERSION)
PARROT_LIBRARY_DIR = $(PARROT_LIB_DIR)/library
NQP_LANG_DIR       = $(PARROT_LIB_DIR)/languages/nqp
HAS_ICU            = @has_icu@

CC            = @cc@
CFLAGS        = @ccflags@ @cc_shared@ @optimize@ @cc_debug@ @ccwarn@ @gc_flag@
EXE           = @exe@
LD            = @ld@
LDFLAGS       = @ldflags@ @optimize@ @ld_debug@
LD_LOAD_FLAGS = @ld_load_flags@
LIBPARROT     = @inst_libparrot_ldflags@
O             = @o@
A             = @a@
LOAD_EXT      = @load_ext@
PERL          = @perl@
CP            = @cp@
MV            = @mv@
RM_F          = @rm_f@
MKPATH        = $(PERL) -MExtUtils::Command -e mkpath
CHMOD         = $(PERL) -MExtUtils::Command -e chmod

# locations of parrot resources
PARROT            = $(PARROT_BIN_DIR)/parrot$(EXE)
PARROT_DLL        = @dll@
PARROT_DLL_COPY   = @dllcopy@
PARROT_NQP        = $(PARROT_BIN_DIR)/parrot_nqp$(EXE)
PBC_TO_EXE        = $(PARROT_BIN_DIR)/pbc_to_exe$(EXE)
PARROT_TOOLS_DIR  = $(PARROT_LIB_DIR)/tools
PARROT_PERL_LIB   = $(PARROT_TOOLS_DIR)/lib
OPS2C             = $(PARROT_BIN_DIR)/ops2c$(EXE)
PMC2C             = $(PERL) $(PARROT_TOOLS_DIR)/build/pmc2c.pl
PMC2C_INCLUDES    = --include src/pmc --include $(PARROT_SRC_DIR) --include $(PARROT_SRC_DIR)/pmc
CINCLUDES         = -I$(PARROT_INCLUDE_DIR) -I$(PARROT_INCLUDE_DIR)/pmc
LINKARGS          = $(LDFLAGS) $(LD_LOAD_FLAGS) $(LIBPARROT) @libs@ @icu_shared@
NQP               = $(PARROT_BIN_DIR)/nqp$(EXE)

# output directories
DYNEXT_DIR       = dynext
OPS_DIR          = src/ops

OPS             = mvmcc_ops
DYNEXT_TARGET   = $(DYNEXT_DIR)/$(OPS)$(LOAD_EXT)
DYNOPS          = $(OPS_DIR)/$(OPS)$(LOAD_EXT)

OPS_SOURCE      = mvmcc.ops

# Cross-compiler libraries
CROSS_COMP_PBCS = MASTNodes.pbc MASTOps.pbc MASTCompiler.pbc MASTTesting.pbc QASTCompilerMAST.pbc QASTRegexCompilerMAST.pbc NQPCursorQAST.pbc

# Related to cross-compilation of NQP
PRECOMPILE_NS   = $(NQP) --target=pir --setting=NULL --stable-sc --output=$@
CROSSCOMPILE_NS = $(NQP) nqp-moar-cc.nqp --setting=NULL --target=mbc --output=$@
.SUFFIXES: .pir .pbc

# The cross-compilation of NQP to Moar; we also build Parrot versions of the
# things being cross-compiled.
NQPLIBS    = nqp-mo.moarvm ModuleLoader.class NQPCOREMoar.setting.moarvm
NQPLIBPIRS = nqp-mo.pir NQPCOREMoar.setting.pir

CLEANUPS = \
  *.manifest \
  *.pdb \
  $(PARROT_DLL_COPY) \
  $(OPS_DIR)/*.h \
  $(OPS_DIR)/*.c \
  $(OPS_DIR)/*$(O) \
  $(OPS_DIR)/*$(LOAD_EXT) \
  $(DYNEXT_DIR)/*$(LOAD_EXT) \
  *.pbc \
  *.pir \

all: $(DYNEXT_TARGET) $(CROSS_COMP_PBCS) $(NQPLIBS)

## Ops

@make_dllcopy@

$(DYNEXT_TARGET): $(DYNOPS)
	$(CP) $(DYNOPS) $(DYNEXT_DIR)
	$(CHMOD) 755 $(DYNEXT_DIR)/$(OPS)$(LOAD_EXT)

$(OPS_DIR)/$(OPS)$(LOAD_EXT): $(OPS_DIR)/$(OPS_SOURCE) src/nodes_parrot.h ../../src/mast/compiler.c ../../src/core/ops.c src/sixmodelobject.h src/storage_spec.h src/serialization.h
	cd $(OPS_DIR) && $(OPS2C) C --dynamic $(OPS_SOURCE)
	cd $(OPS_DIR) && $(CC) -c @cc_o_out@$(OPS)$(O) $(CINCLUDES) $(CFLAGS) -I.. $(OPS).c
	cd src && $(CC) -c @cc_o_out@compiler$(O) $(CINCLUDES) $(CFLAGS) -I. -DPARROT_OPS_BUILD ../../../src/mast/compiler.c
	cd src && $(CC) -c @cc_o_out@ops$(O) $(CINCLUDES) $(CFLAGS) -I. -DPARROT_OPS_BUILD ../../../src/core/ops.c
	cd $(OPS_DIR) && $(LD) @ld_out@$(OPS)$(LOAD_EXT) $(OPS)$(O) ../ops$(O) ../compiler$(O) $(LINKARGS)

## Cross-compiler

MASTOps.pbc: ../../lib/MAST/Ops.nqp
	nqp --target=pir ../../lib/MAST/Ops.nqp > MASTOps.pir
	parrot --output=MASTOps.pbc MASTOps.pir

MASTNodes.pbc: ../../lib/MAST/Nodes.nqp MASTOps.pbc
	nqp --target=pir ../../lib/MAST/Nodes.nqp > MASTNodes.pir
	parrot --output=MASTNodes.pbc MASTNodes.pir

MASTCompiler.pbc: src/MASTCompiler.nqp MASTNodes.pbc MASTOps.pbc $(DYNEXT_TARGET)
	nqp --vmlibs=mvmcc_ops --target=pir src/MASTCompiler.nqp > MASTCompiler.pir
	parrot --output=MASTCompiler.pbc MASTCompiler.pir

MASTTesting.pbc: MASTCompiler.pbc src/MASTTesting.nqp QASTCompilerMAST.pbc
	nqp --vmlibs=mvmcc_ops --target=pir src/MASTTesting.nqp > MASTTesting.pir
	parrot --output=MASTTesting.pbc MASTTesting.pir

QASTOperationsMAST.pbc: MASTNodes.pbc MASTOps.pbc src/QASTOperationsMAST.nqp
	nqp --target=pir src/QASTOperationsMAST.nqp > QASTOperationsMAST.pir
	parrot --output=QASTOperationsMAST.pbc QASTOperationsMAST.pir

QASTCompilerMAST.pbc: MASTNodes.pbc MASTOps.pbc QASTOperationsMAST.pbc QASTRegexCompilerMAST.pbc src/QASTCompilerMAST.nqp
	nqp --target=pir src/QASTCompilerMAST.nqp > QASTCompilerMAST.pir
	parrot --output=QASTCompilerMAST.pbc QASTCompilerMAST.pir

QASTRegexCompilerMAST.pbc: MASTNodes.pbc MASTOps.pbc QASTOperationsMAST.pbc src/QASTRegexCompilerMAST.nqp NQPCursorQAST.pbc
	nqp --target=pir src/QASTRegexCompilerMAST.nqp > QASTRegexCompilerMAST.pir
	parrot --output=QASTRegexCompilerMAST.pbc QASTRegexCompilerMAST.pir

NQPCursorQAST.pbc: src/NQPCursorQAST.nqp
	nqp --target=pir src/NQPCursorQAST.nqp > NQPCursorQAST.pir
	parrot --output=NQPCursorQAST.pbc NQPCursorQAST.pir

## NQP -> Moar

.pir.pbc:
	$(PARROT) -o $@ $*.pir

nqp-mo.pir: nqp-src/nqp-mo.pm $(CROSS_COMP_PBCS)
	$(PRECOMPILE_NS) nqp-src/nqp-mo.pm

NQPCOREMoar.setting.pir: nqp-src/NQPCORE.setting nqp-mo.pbc $(CROSS_COMP_PBCS)
	$(PRECOMPILE_NS) nqp-src/NQPCORE.setting

nqp-mo.moarvm: nqp-src/nqp-mo.pm nqp-mo.pbc $(CROSS_COMP_PBCS)
	$(CROSSCOMPILE_NS) nqp-src/nqp-mo.pm

ModuleLoader.class: nqp-src/ModuleLoader.pm $(CROSS_COMP_PBCS)
	$(CROSSCOMPILE_NS) nqp-src/ModuleLoader.pm

NQPCOREMoar.setting.moarvm: nqp-src/NQPCORE.setting NQPCOREMoar.setting.pbc $(CROSS_COMP_PBCS)
	$(CROSSCOMPILE_NS) nqp-src/NQPCORE.setting

## testing

test: all
	prove -e nqp t/moar t/qast

bench: all
	prove -e nqp -v bench

nqptest: all
	prove -e "nqp nqp-moar-cc.nqp" t/nqp

## cleaning

clean:
	$(RM_F) $(CLEANUPS)

distclean: realclean

realclean: clean
	$(RM_F) Makefile

testclean:

# nqp::makefile <-- tells Configure.pm to convert / to \ in the above
#                   template for Win32 systems
