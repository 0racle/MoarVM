# Compiler configuration
CC       = @cc@
CFLAGS   = @cflags@
CINCLUDE = -I3rdparty/apr/include -Isrc
LD       = @link@
LDFLAGS  = @ldflags@

# File extensions
EXE = @exe@
O   = @o@

# Tool configuration
MAKE = @make@
RM   = @rm@

# APR related
APR_LIB = @apr_lib@
APR_BUILD_LINE = @apr_build_line@

# Various collections of libraries, objects and sources.
THIRDPARTY_LIBS = $(APR_LIB)
CORE_OBJS = src/core/args$(O) src/core/exceptions$(O) src/core/interp$(O) src/core/threadcontext$(O) \
            src/core/compunit$(O) src/core/bytecode$(O) src/gc/allocation$(O) src/gc/roots$(O)  \
            src/gc/wb$(O) src/6model/reprs$(O) src/6model/reprs/MVMString$(O) \
            src/6model/reprs/MVMArray$(O) src/6model/reprs/MVMHash$(O) \
            src/6model/reprs/MVMCFunction$(O) src/6model/reprs/KnowHOWREPR$(O) \
            src/6model/reprs/P6opaque$(O) src/6model/reprs/MVMCode$(O) \
            src/6model/bootstrap$(O) src/strings/ascii$(O) src/strings/utf8$(O) \
            src/strings/ops$(O) src/moarvm$(O)
MAIN_OBJ  = src/main$(O)
HEADERS   = src/moarvm.h src/6model/6model.h src/core/instance.h src/core/threadcontext.h \
            src/core/args.h src/core/exceptions.h src/core/interp.h src/core/frame.h \
            src/core/compunit.h src/core/bytecode.h src/core/ops.h \
            src/gc/allocation.h src/gc/nursery.h src/gc/roots.h src/gc/wb.h \
            src/6model/reprs.h src/6model/bootstrap.h src/6model/reprs/MVMString.h \
            src/6model/reprs/MVMArray.h src/6model/reprs/MVMHash.h src/6model/reprs/MVMCFunction.h \
            src/6model/reprs/KnowHOWREPR.h src/6model/reprs/P6opaque.h src/6model/reprs/MVMCode.h \
            src/strings/ascii.h src/strings/utf8.h src/strings/ops.h

# Main target
moarvm$(EXE): $(THIRDPARTY_LIBS) $(CORE_OBJS) $(MAIN_OBJ)
	$(LD) -out:moarvm$(EXE) $(LDFLAGS) $(CORE_OBJS) $(MAIN_OBJ) $(THIRDPARTY_LIBS)

# APR
$(APR_LIB):
	$(APR_BUILD_LINE)

# VM core compilation.
src/core/args$(O): src/core/args.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/core/args$(O) src/core/args.c
src/core/exceptions$(O): src/core/exceptions.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/core/exceptions$(O) src/core/exceptions.c
src/core/interp$(O): src/core/interp.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/core/interp$(O) src/core/interp.c
src/core/compunit$(O): src/core/compunit.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/core/compunit$(O) src/core/compunit.c
src/core/bytecode$(O): src/core/bytecode.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/core/bytecode$(O) src/core/bytecode.c
src/core/threadcontext$(O): src/core/threadcontext.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/core/threadcontext$(O) src/core/threadcontext.c
src/gc/allocation$(O): src/gc/allocation.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/gc/allocation$(O) src/gc/allocation.c
src/gc/roots$(O): src/gc/roots.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/gc/roots$(O) src/gc/roots.c
src/gc/wb$(O): src/gc/wb.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/gc/wb$(O) src/gc/wb.c
src/6model/reprs$(O): src/6model/reprs.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/6model/reprs$(O) src/6model/reprs.c
src/6model/reprs/MVMString$(O): src/6model/reprs/MVMString.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/6model/reprs/MVMString$(O) src/6model/reprs/MVMString.c
src/6model/reprs/MVMArray$(O): src/6model/reprs/MVMArray.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/6model/reprs/MVMArray$(O) src/6model/reprs/MVMArray.c
src/6model/reprs/MVMHash$(O): src/6model/reprs/MVMHash.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/6model/reprs/MVMHash$(O) src/6model/reprs/MVMHash.c
src/6model/reprs/MVMCFunction$(O): src/6model/reprs/MVMCFunction.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/6model/reprs/MVMCFunction$(O) src/6model/reprs/MVMCFunction.c
src/6model/reprs/KnowHOWREPR$(O): src/6model/reprs/KnowHOWREPR.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/6model/reprs/KnowHOWREPR$(O) src/6model/reprs/KnowHOWREPR.c
src/6model/reprs/P6opaque$(O): src/6model/reprs/P6opaque.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/6model/reprs/P6opaque$(O) src/6model/reprs/P6opaque.c
src/6model/reprs/MVMCode$(O): src/6model/reprs/MVMCode.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/6model/reprs/MVMCode$(O) src/6model/reprs/MVMCode.c
src/6model/bootstrap$(O): src/6model/bootstrap.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/6model/bootstrap$(O) src/6model/bootstrap.c
src/strings/ascii$(O): src/strings/ascii.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/strings/ascii$(O) src/strings/ascii.c
src/strings/utf8$(O): src/strings/utf8.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/strings/utf8$(O) src/strings/utf8.c
src/strings/ops$(O): src/strings/ops.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/strings/ops$(O) src/strings/ops.c
src/moarvm$(O): src/moarvm.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/moarvm$(O) src/moarvm.c
src/main$(O): src/main.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/main$(O) src/main.c

# Cleanup.
clean:
	$(RM) moarvm$(EXE)
	$(RM) src/*$(O) src/6model/*$(O) src/core/*$(O) src/gc/*$(O) src/strings/*$(O)
