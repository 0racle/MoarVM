# Compiler configuration
CC       = @cc@
CFLAGS   = @cflags@
CINCLUDE = -I3rdparty/apr/include -I3rdparty/libatomic_ops/src -Isrc -I3rdparty
LD       = @link@
LDFLAGS  = @ldflags@
LLIBS    = @llibs@
COUTO    = @couto@
LOUTO    = @louto@

# File extensions
EXE = @exe@
O   = @o@

# Tool configuration
MAKE = @make@
RM   = @rm@
CAT  = @cat@

# APR related
APR_LIB = @apr_lib@
APR_BUILD_LINE = @apr_build_line@

# libatomic_ops related
LAO_LIB = @lao_lib@
LAO_BUILD_LINE = @lao_build_line@
# the following will be the same as LAO_LIB if it's to be built, otherwise blank
BUILD_LAO_LIB = @lao_whether_build@

# Various collections of libraries, objects and sources.
THIRDPARTY_LIBS = $(APR_LIB) $(BUILD_LAO_LIB)
CORE_OBJS = src/core/args$(O) src/core/exceptions$(O) src/core/interp$(O) src/core/threadcontext$(O) \
            src/core/compunit$(O) src/core/bytecode$(O) src/core/frame$(O) src/core/validation$(O) \
            src/core/bytecodedump$(O) src/core/threads$(O) src/core/ops$(O) src/core/hll$(O) \
            src/gc/orchestrate$(O) src/gc/allocation$(O) src/gc/worklist$(O) src/gc/roots$(O) \
            src/io/fileops$(O) src/io/socketops$(O) src/io/dirops$(O) src/io/procops$(O) \
            src/gc/collect$(O) src/gc/gen2$(O) src/gc/wb$(O) src/6model/reprs$(O) \
            src/6model/reprconv$(O) src/6model/reprs/MVMString$(O) \
            src/6model/reprs/MVMArray$(O) src/6model/reprs/MVMHash$(O) \
            src/6model/reprs/MVMCFunction$(O) src/6model/reprs/KnowHOWREPR$(O) \
            src/6model/reprs/KnowHOWAttributeREPR$(O) src/6model/reprs/P6str$(O) \
            src/6model/reprs/P6opaque$(O) src/6model/reprs/MVMCode$(O) \
            src/6model/reprs/MVMOSHandle$(O) src/6model/reprs/P6int$(O) src/6model/reprs/P6num$(O) \
            src/6model/reprs/Uninstantiable$(O) src/6model/reprs/HashAttrStore$(O) \
            src/6model/reprs/MVMThread$(O) src/6model/reprs/MVMIter$(O) \
            src/6model/6model$(O) src/6model/bootstrap$(O) src/6model/sc$(O) src/strings/ascii$(O) \
            src/strings/utf8$(O) src/strings/ops$(O) src/strings/unicode$(O) \
            src/strings/latin1$(O) src/strings/utf16$(O) src/moarvm$(O)
MAIN_OBJ  = src/main$(O)
HEADERS   = src/moarvm.h src/6model/6model.h src/core/instance.h src/core/threadcontext.h \
            src/core/args.h src/core/exceptions.h src/core/interp.h src/core/frame.h \
            src/core/compunit.h src/core/bytecode.h src/core/ops.h src/core/validation.h \
            src/core/bytecodedump.h src/core/threads.h src/core/hll.h \
            src/io/fileops.h src/io/socketops.h src/io/dirops.h src/io/procops.h src/gc/orchestrate.h \
            src/gc/allocation.h src/gc/worklist.h src/gc/collect.h src/gc/roots.h src/gc/gen2.h \
            src/gc/wb.h src/6model/reprs.h src/6model/reprconv.h src/6model/bootstrap.h src/6model/reprs/MVMString.h \
            src/6model/reprs/MVMArray.h src/6model/reprs/MVMHash.h src/6model/reprs/MVMCFunction.h \
            src/6model/reprs/KnowHOWREPR.h src/6model/reprs/KnowHOWAttributeREPR.h \
            src/6model/reprs/P6opaque.h src/6model/reprs/MVMCode.h src/6model/reprs/P6str.h \
            src/6model/reprs/MVMOSHandle.h src/6model/reprs/P6int.h src/6model/reprs/P6num.h \
            src/6model/reprs/Uninstantiable.h src/6model/reprs/HashAttrStore.h \
            src/6model/reprs/MVMThread.h src/6model/reprs/MVMIter.h \
            src/6model/sc.h src/strings/unicode_gen.h \
            src/strings/ascii.h src/strings/utf8.h src/strings/ops.h src/strings/unicode.h \
            src/strings/latin1.h src/strings/utf16.h 3rdparty/uthash.h src/gen/config.h

# Main target
moarvm$(EXE): $(THIRDPARTY_LIBS) $(CORE_OBJS) $(MAIN_OBJ)
	$(LD) $(LOUTO)moarvm$(EXE) $(LDFLAGS) $(CORE_OBJS) $(MAIN_OBJ) $(THIRDPARTY_LIBS) $(LLIBS)

# APR
$(APR_LIB):
	$(APR_BUILD_LINE)

# libatomic_ops
$(LAO_LIB):
	$(LAO_BUILD_LINE)

# Generated unicode database
src/strings/unicode.c: src/strings/unicode_db.c src/strings/unicode_ops.c
	$(CAT) src/strings/unicode_db.c >src/strings/unicode.c
	$(CAT) src/strings/unicode_ops.c >>src/strings/unicode.c

# VM core compilation.
src/core/args$(O): src/core/args.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/args$(O) src/core/args.c
src/core/exceptions$(O): src/core/exceptions.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/exceptions$(O) src/core/exceptions.c
src/core/interp$(O): src/core/interp.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/interp$(O) src/core/interp.c
src/core/compunit$(O): src/core/compunit.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/compunit$(O) src/core/compunit.c
src/core/bytecode$(O): src/core/bytecode.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/bytecode$(O) src/core/bytecode.c
src/core/frame$(O): src/core/frame.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/frame$(O) src/core/frame.c
src/core/validation$(O): src/core/validation.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/validation$(O) src/core/validation.c
src/core/bytecodedump$(O): src/core/bytecodedump.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/bytecodedump$(O) src/core/bytecodedump.c
src/core/ops$(O): src/core/ops.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/ops$(O) src/core/ops.c
src/core/threads$(O): src/core/threads.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/threads$(O) src/core/threads.c
src/core/hll$(O): src/core/hll.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/hll$(O) src/core/hll.c
src/io/fileops$(O): src/io/fileops.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/io/fileops$(O) src/io/fileops.c
src/io/socketops$(O): src/io/socketops.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/io/socketops$(O) src/io/socketops.c
src/io/dirops$(O): src/io/dirops.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/io/dirops$(O) src/io/dirops.c
src/io/procops$(O): src/io/procops.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/io/procops$(O) src/io/procops.c
src/core/threadcontext$(O): src/core/threadcontext.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/core/threadcontext$(O) src/core/threadcontext.c
src/gc/allocation$(O): src/gc/allocation.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/gc/allocation$(O) src/gc/allocation.c
src/gc/worklist$(O): src/gc/worklist.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/gc/worklist$(O) src/gc/worklist.c
src/gc/roots$(O): src/gc/roots.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/gc/roots$(O) src/gc/roots.c
src/gc/collect$(O): src/gc/collect.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/gc/collect$(O) src/gc/collect.c
src/gc/orchestrate$(O): src/gc/orchestrate.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/gc/orchestrate$(O) src/gc/orchestrate.c
src/gc/gen2$(O): src/gc/gen2.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/gc/gen2$(O) src/gc/gen2.c
src/gc/wb$(O): src/gc/wb.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/gc/wb$(O) src/gc/wb.c
src/6model/reprs$(O): src/6model/reprs.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs$(O) src/6model/reprs.c
src/6model/reprconv$(O): src/6model/reprconv.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprconv$(O) src/6model/reprconv.c
src/6model/reprs/MVMString$(O): src/6model/reprs/MVMString.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/MVMString$(O) src/6model/reprs/MVMString.c
src/6model/reprs/MVMArray$(O): src/6model/reprs/MVMArray.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/MVMArray$(O) src/6model/reprs/MVMArray.c
src/6model/reprs/MVMHash$(O): src/6model/reprs/MVMHash.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/MVMHash$(O) src/6model/reprs/MVMHash.c
src/6model/reprs/MVMCFunction$(O): src/6model/reprs/MVMCFunction.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/MVMCFunction$(O) src/6model/reprs/MVMCFunction.c
src/6model/reprs/KnowHOWREPR$(O): src/6model/reprs/KnowHOWREPR.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/KnowHOWREPR$(O) src/6model/reprs/KnowHOWREPR.c
src/6model/reprs/P6opaque$(O): src/6model/reprs/P6opaque.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/P6opaque$(O) src/6model/reprs/P6opaque.c
src/6model/reprs/MVMCode$(O): src/6model/reprs/MVMCode.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/MVMCode$(O) src/6model/reprs/MVMCode.c
src/6model/reprs/MVMOSHandle$(O): src/6model/reprs/MVMOSHandle.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/MVMOSHandle$(O) src/6model/reprs/MVMOSHandle.c
src/6model/reprs/P6int$(O): src/6model/reprs/P6int.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/P6int$(O) src/6model/reprs/P6int.c
src/6model/reprs/P6num$(O): src/6model/reprs/P6num.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/P6num$(O) src/6model/reprs/P6num.c
src/6model/reprs/P6str$(O): src/6model/reprs/P6str.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/P6str$(O) src/6model/reprs/P6str.c
src/6model/reprs/Uninstantiable$(O): src/6model/reprs/Uninstantiable.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/Uninstantiable$(O) src/6model/reprs/Uninstantiable.c
src/6model/reprs/HashAttrStore$(O): src/6model/reprs/HashAttrStore.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/HashAttrStore$(O) src/6model/reprs/HashAttrStore.c
src/6model/reprs/KnowHOWAttributeREPR$(O): src/6model/reprs/KnowHOWAttributeREPR.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/KnowHOWAttributeREPR$(O) src/6model/reprs/KnowHOWAttributeREPR.c
src/6model/reprs/MVMThread$(O): src/6model/reprs/MVMThread.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/MVMThread$(O) src/6model/reprs/MVMThread.c
src/6model/reprs/MVMIter$(O): src/6model/reprs/MVMIter.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/reprs/MVMIter$(O) src/6model/reprs/MVMIter.c
src/6model/6model$(O): src/6model/6model.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/6model$(O) src/6model/6model.c
src/6model/bootstrap$(O): src/6model/bootstrap.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/bootstrap$(O) src/6model/bootstrap.c
src/6model/sc$(O): src/6model/sc.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/6model/sc$(O) src/6model/sc.c
src/strings/ascii$(O): src/strings/ascii.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/strings/ascii$(O) src/strings/ascii.c
src/strings/utf8$(O): src/strings/utf8.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/strings/utf8$(O) src/strings/utf8.c
src/strings/ops$(O): src/strings/ops.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/strings/ops$(O) src/strings/ops.c
src/strings/unicode$(O): src/strings/unicode.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/strings/unicode$(O) src/strings/unicode.c
src/strings/latin1$(O): src/strings/latin1.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/strings/latin1$(O) src/strings/latin1.c
src/strings/utf16$(O): src/strings/utf16.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/strings/utf16$(O) src/strings/utf16.c
src/moarvm$(O): src/moarvm.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/moarvm$(O) src/moarvm.c
src/main$(O): src/main.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c $(COUTO)src/main$(O) src/main.c

# Cleanup.
clean:
	$(RM) moarvm$(EXE)
	$(RM) src/*$(O) src/6model/*$(O) src/6model/reprs/*$(O) src/core/*$(O) src/gc/*$(O) src/strings/*$(O) src/strings/unicode.c src/io/*$(O)
