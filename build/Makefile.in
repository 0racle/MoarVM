# Compiler configuration
CC       = @cc@
CFLAGS   = @cflags@
CINCLUDE = -I3rdparty/apr/include -Isrc
LD       = @link@
LDFLAGS  = @ldflags@

# File extensions
EXE = @exe@
O   = @o@

# Tool configuration
MAKE = @make@
RM   = @rm@

# APR related
APR_LIB = @apr_lib@
APR_BUILD_LINE = @apr_build_line@

# Various collections of libraries, objects and sources.
THIRDPARTY_LIBS = $(APR_LIB)
CORE_OBJS = src/core/exceptions$(O) src/core/threadcontext$(O) src/gc/allocation$(O) \
            src/6model/reprs/MVMString$(O) src/strings/ascii$(O) src/moarvm$(O)
MAIN_OBJ  = src/main$(O)
HEADERS   = src/moarvm.h src/6model/6model.h src/core/instance.h src/core/threadcontext.h \
            src/core/exceptions.h src/gc/allocation.h src/gc/nursery.h \
            src/6model/reprs.h src/6model/reprs/MVMString.h \
            src/strings/ascii.h

# Main target
moarvm$(EXE): $(THIRDPARTY_LIBS) $(CORE_OBJS) $(MAIN_OBJ)
	$(LD) -out:moarvm$(EXE) $(LDFLAGS) $(CORE_OBJS) $(MAIN_OBJ) $(THIRDPARTY_LIBS)

# APR
$(APR_LIB):
	$(APR_BUILD_LINE)

# VM core compilation.
src/core/exceptions$(O): src/core/exceptions.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/core/exceptions$(O) src/core/exceptions.c
src/core/threadcontext$(O): src/core/threadcontext.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/core/threadcontext$(O) src/core/threadcontext.c
src/gc/allocation$(O): src/gc/allocation.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/gc/allocation$(O) src/gc/allocation.c
src/6model/reprs/MVMString$(O): src/6model/reprs/MVMString.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/6model/reprs/MVMString$(O) src/6model/reprs/MVMString.c
src/strings/ascii$(O): src/strings/ascii.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/strings/ascii$(O) src/strings/ascii.c
src/moarvm$(O): src/moarvm.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/moarvm$(O) src/moarvm.c
src/main$(O): src/main.c $(HEADERS)
	$(CC) $(CINCLUDE) $(CFLAGS) -c -Fosrc/main$(O) src/main.c

# Cleanup.
clean:
	$(RM) moarvm$(EXE)
	$(RM) src/*$(O) src/6model/*$(O) src/core/*$(O) src/gc/*$(O) src/strings/*$(O)
